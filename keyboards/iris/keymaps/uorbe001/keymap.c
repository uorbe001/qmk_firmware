#include QMK_KEYBOARD_H
#include "uorbe001.h"

extern keymap_config_t keymap_config;

#define UC_TILDE_LOWER_A 0x00e1
#define UC_TILDE_UPPER_A 0x00c1
#define UC_TILDE_LOWER_E 0x00e9
#define UC_TILDE_UPPER_E 0x00c9
#define UC_TILDE_LOWER_I 0x00ed
#define UC_TILDE_UPPER_I 0x00cd
#define UC_TILDE_LOWER_O 0x00d3
#define UC_TILDE_UPPER_O 0x00f3
#define UC_TILDE_LOWER_U 0x00fa
#define UC_TILDE_UPPER_U 0x00da
#define UC_TILDE_LOWER_N 0x00d1
#define UC_TILDE_UPPER_N 0x00f1
#define UC_EURO 0x20ac

enum custom_keycodes {
  ACCENTS = SAFE_RANGE,
  TILDE_A,
  TILDE_E,
  TILDE_I,
  TILDE_O,
  TILDE_U,
  TILDE_N
};

enum layers {
  QWERTY,
  MM_LAYER,
  NUM_LAYER,
  FUNC_LAYER,
  MOUSE_LAYER,
  ACCENTS_LAYER
};

#define MAGIC_F LT(FUNC_LAYER, KC_F)
#define MAGIC_D LT(NUM_LAYER, KC_D)
#define MAGIC_S LT(MM_LAYER, KC_S)
#define MAGIC_A LT(MOUSE_LAYER, KC_A)
#define CTL_ESC CTL_T(KC_ESCAPE)
#define CMD_QUOT RGUI_T(KC_QUOT)
#define SPACE_LSHIFT RSFT_T(KC_SPACE)
#define SPACE_RSHIFT LSFT_T(KC_SPACE)
#define ENT_CTL CTL_T(KC_ENTER)
#define MINUS_ALT LALT_T(KC_MINUS)
#define EQL_ALT RALT_T(KC_EQUAL)

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
  [QWERTY] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     ACCENTS,  KC_1,    KC_2,    KC_3,    KC_4,    KC_5,                               KC_6,    KC_7,    KC_8,    KC_9,    KC_0,   KC_BSPC,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     KC_TAB,  KC_Q,    KC_W,    KC_E,    KC_R,    KC_T,                               KC_Y,    KC_U,    KC_I,    KC_O,    KC_P,    TD(BRACKETS),
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     CTL_ESC, MAGIC_A, MAGIC_S, MAGIC_D, MAGIC_F, KC_G,                              KC_H,    KC_J,    KC_K,    KC_L,    KC_SCLN, CMD_QUOT,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     KC_LSPO, KC_Z,    KC_X,    KC_C,    KC_V,    KC_B, SPACE_LSHIFT,    SPACE_RSHIFT, KC_N, KC_M,   KC_COMM, KC_DOT,  TD(SLASH), KC_RSPC,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    MINUS_ALT, ENT_CTL, SPACE_LSHIFT,          SPACE_RSHIFT,ENT_CTL,EQL_ALT
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  ),

  [FUNC_LAYER] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     KC_F12,   KC_F1,   KC_F2,   KC_F3,   KC_F4,   KC_F5,                              KC_F6,   KC_F7,   KC_F8,   KC_F9,   KC_F10,   KC_F11,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            KC_LEFT, KC_DOWN, KC_UP,   KC_RIGHT, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______, _______,          _______, _______, _______, _______, _______, _______, _______,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    _______, _______, _______,                   _______, _______, _______
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  ),

  [NUM_LAYER] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     _______, _______, _______, _______, _______, _______,                         _______, KC_KP_ASTERISK,KC_KP_SLASH, KC_KP_MINUS,_______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            _______, KC_KP_7, KC_KP_8, KC_KP_9, KC_KP_PLUS, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            KC_KP_0, KC_KP_4, KC_KP_5, KC_KP_6, KC_KP_ENTER, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______, _______,          _______, KC_KP_0, KC_KP_1, KC_KP_2, KC_KP_3, KC_KP_DOT, _______,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    _______, _______, _______,                   _______, _______, _______
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  ),

  [MM_LAYER] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     _______, _______, _______, _______, _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            KC_MRWD, KC_VOLD, KC_VOLU, KC_MFFD, KC_MPLY, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______, _______,          _______, _______, _______, KC_MUTE, _______, _______, _______,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    _______, _______, _______,                   _______, _______, _______
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  ),

  [MOUSE_LAYER] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     _______, _______, _______, _______, _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            _______, KC_WH_D, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______,                            KC_MS_L, KC_MS_D,  KC_MS_U, KC_MS_R, KC_BTN1, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______, _______,          _______, KC_ACL0, KC_WH_U, KC_ACL2, _______, _______, _______,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    _______, _______, _______,                   _______, _______, _______
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  ),

  [ACCENTS_LAYER] = LAYOUT(
  //┌────────┬────────┬────────┬────────┬────────┬────────┐                          ┌────────┬────────┬────────┬────────┬────────┬────────┐
     KC_GRAVE, _______, _______, _______,UC(UC_EURO),_______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, TILDE_E, _______, _______,                         _______,TILDE_U,TILDE_I,TILDE_O, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┤                          ├────────┼────────┼────────┼────────┼────────┼────────┤
     _______, TILDE_A, _______, _______, _______, _______,                            _______, _______, _______, _______, _______, _______,
  //├────────┼────────┼────────┼────────┼────────┼────────┼────────┐        ┌────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     _______, _______, _______, _______, _______, _______, _______,          _______, TILDE_N, _______, _______, _______, UC(0x00bf), _______,
  //└────────┴────────┴────────┴───┬────┴───┬────┴───┬────┴───┬────┘        └───┬────┴───┬────┴───┬────┴───┬────┴────────┴────────┴────────┘
                                    _______, _______, _______,                   _______, _______, _______
                                // └────────┴────────┴────────┘                 └────────┴────────┴────────┘
  )
};

void matrix_init_user(void) {
    set_unicode_input_mode(UC_OSX); // REPLACE UC_XXXX with the Unicode Input Mode for your OS. See table below.
};

bool send_shifty_unicode (uint16_t regular, uint16_t shifted) {
  bool is_capital = ( keyboard_report->mods & (MOD_BIT(KC_LSFT) |MOD_BIT(KC_RSFT)) );

  unicode_input_start();
  register_hex(is_capital ? shifted : regular);
  unicode_input_finish();
  return false;
}

bool process_shifty_unicode (keyrecord_t *record, uint16_t regular, uint16_t shifted) {
  if (!record->event.pressed) {
    return send_shifty_unicode(regular, shifted);
  }

  return true;
}

bool accents_layer_on = false;

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  switch (keycode) {
    case TILDE_A:
      return process_shifty_unicode(record, UC_TILDE_LOWER_A, UC_TILDE_UPPER_A);
    case TILDE_E:
      return process_shifty_unicode(record, UC_TILDE_LOWER_E, UC_TILDE_UPPER_E);
    case TILDE_I:
      return process_shifty_unicode(record, UC_TILDE_LOWER_I, UC_TILDE_UPPER_I);
    case TILDE_U:
      return process_shifty_unicode(record, UC_TILDE_LOWER_U, UC_TILDE_UPPER_U);
    case TILDE_O:
      return process_shifty_unicode(record, UC_TILDE_UPPER_O, UC_TILDE_LOWER_O);
    case TILDE_N:
      return process_shifty_unicode(record, UC_TILDE_UPPER_N, UC_TILDE_LOWER_N);
    case ACCENTS:
      if (!record->event.pressed) {
        // Do something else when release
        accents_layer_on = true;
        layer_on(ACCENTS_LAYER);
        set_oneshot_layer(ACCENTS_LAYER, ONESHOT_PRESSED);
      }
      return false; // Skip all further processing of this key
    default:
      if (accents_layer_on && !record->event.pressed) {
        clear_oneshot_layer_state(ONESHOT_PRESSED);
        accents_layer_on = false;
      }

      return true; // Process all other keycodes normally
  }
}
